name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies (Ubuntu)
      run: |
        sudo apt-get update
        sudo apt-get install -y libwebkit2gtk-4.1-dev \
          build-essential \
          curl \
          wget \
          file \
          libssl-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          libasound2-dev

    - name: Install frontend dependencies
      run: npm install

    - name: Build Tauri app
      run: npm run tauri build

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-executable
        path: |
          src-tauri/target/release/bundle/deb/*.deb
          src-tauri/target/release/bundle/appimage/*.AppImage

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v6

    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install frontend dependencies
      run: npm install

    - name: Build Tauri app
      run: npm run tauri build

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: |
          src-tauri/target/release/bundle/msi/*.msi
          src-tauri/target/release/bundle/nsis/*.exe

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v6

    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: linux-executable
        path: dist/linux

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-executable
        path: dist/windows

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/linux/**/*.deb
          dist/linux/**/*.AppImage
          dist/windows/**/*.msi
          dist/windows/**/*.exe
        body: |
          ## Downloads

          ### Windows
          - **soundboard-setup.exe** or **soundboard.msi** - Windows installer

          ### Linux
          - **soundboard.deb** - Debian/Ubuntu package
          - **soundboard.AppImage** - Universal Linux application

          ## Installation

          ### Windows
          1. Download the .exe or .msi file
          2. Run the installer
          3. Follow installation prompts

          ### Linux (Debian/Ubuntu)
          1. Download the .deb file
          2. Install: `sudo dpkg -i soundboard*.deb`

          ### Linux (AppImage)
          1. Download the .AppImage file
          2. Make it executable: `chmod +x soundboard*.AppImage`
          3. Run: `./soundboard*.AppImage`

          ## What's New
          See commit history for detailed changes.

          ---
          ðŸ¤– Built automatically with GitHub Actions
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
